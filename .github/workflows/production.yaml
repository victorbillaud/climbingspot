name: Deploy Migrations to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04

    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
      PRODUCTION_PROJECT_ID: pbtxcelbykjcjukklxqk

    steps:
      - uses: actions/checkout@v3

      - uses: supabase/setup-cli@v1

      - run: |
          supabase link --project-ref $PRODUCTION_PROJECT_ID
          supabase db push
      
      - name: Report deployment status
        if: always()
        uses: actions/github-script@v5
        with:
          script: |
            const { owner, repo } = context.repo;
            const { eventName, sha, runId } = context;
            const { conclusion } = await github.rest.checks.getSuite({ owner, repo, check_suite_id: runId });

            const status = conclusion === 'success' ? 'success' : 'failure';
            const target_url = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            
            const token = process.env.ACTIONS_STATUS_CHECK_TOKEN;
            const octokit = github.getOctokit(token);

            await octokit.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: status,
              target_url,
              description: 'Migrations deployed to production.',
              context: 'Deploy Migrations',
            });
          env:
            ACTIONS_STATUS_CHECK_TOKEN: ${{ secrets.ACTIONS_STATUS_CHECK_TOKEN }}

